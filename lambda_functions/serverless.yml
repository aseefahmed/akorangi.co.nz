# Serverless Framework configuration for AkoRangi Lambda Functions
# Deploy with: serverless deploy

service: akorangi-lambda

provider:
  name: aws
  runtime: python3.12
  region: us-east-1  # Change to your preferred region
  timeout: 30
  memorySize: 512
  
  # Environment variables (set these in AWS Console or use .env)
  environment:
    DATABASE_URL: ${env:DATABASE_URL}
    AUTH0_DOMAIN: ${env:AUTH0_DOMAIN}
    AUTH0_CLIENT_ID: ${env:AUTH0_CLIENT_ID}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY}
  
  # IAM permissions
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "*"

# Package configuration
package:
  individually: true
  patterns:
    - '!.git/**'
    - '!.vscode/**'
    - '!__pycache__/**'
    - '!*.pyc'

# Lambda functions
functions:
  # Authentication
  getUser:
    handler: auth/get_user.lambda_handler
    events:
      - http:
          path: auth/user
          method: get
          cors: true
  
  # Practice Sessions
  createSession:
    handler: practice/create_session.lambda_handler
    events:
      - http:
          path: practice-sessions
          method: post
          cors: true
  
  completeSession:
    handler: practice/complete_session.lambda_handler
    events:
      - http:
          path: practice-sessions/{sessionId}/complete
          method: post
          cors: true
  
  # Questions
  generateQuestion:
    handler: questions/generate.lambda_handler
    timeout: 60  # Longer timeout for OpenAI calls
    events:
      - http:
          path: questions/generate
          method: post
          cors: true
  
  validateAnswer:
    handler: questions/validate.lambda_handler
    timeout: 60  # Longer timeout for OpenAI calls
    events:
      - http:
          path: questions/validate
          method: post
          cors: true
  
  # Achievements
  getUserAchievements:
    handler: achievements/get_user_achievements.lambda_handler
    events:
      - http:
          path: achievements/user
          method: get
          cors: true
  
  # Pets
  getPet:
    handler: pets/get_pet.lambda_handler
    events:
      - http:
          path: pets
          method: get
          cors: true
  
  createPet:
    handler: pets/create_pet.lambda_handler
    events:
      - http:
          path: pets
          method: post
          cors: true
  
  feedPet:
    handler: pets/feed_pet.lambda_handler
    events:
      - http:
          path: pets/feed
          method: post
          cors: true
  
  # Practice Sessions - Additional
  getRecentSessions:
    handler: practice/get_recent_sessions.lambda_handler
    events:
      - http:
          path: practice-sessions/recent
          method: get
          cors: true
  
  getAllSessions:
    handler: practice/get_all_sessions.lambda_handler
    events:
      - http:
          path: practice-sessions/all
          method: get
          cors: true
  
  # Student Links
  createStudentLink:
    handler: students/create_link.lambda_handler
    events:
      - http:
          path: student-links
          method: post
          cors: true

# Plugins
plugins:
  - serverless-python-requirements

custom:
  pythonRequirements:
    dockerizePip: true
    layer: true
    slim: true
    strip: false
